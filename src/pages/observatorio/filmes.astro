---
import Layout from '../../layouts/Layout.astro';
import { XMLParser } from 'fast-xml-parser';

const RSS_URL = 'https://letterboxd.com/lmaitan/rss/';
const TMDB_API_KEY = 'd82459cafca00b8280dfee6161ee5189';

async function getTMDBData(tmdbId: string) {
  if (!tmdbId) return null;
  try {
    const response = await fetch(`https://api.themoviedb.org/3/movie/${tmdbId}?api_key=${TMDB_API_KEY}&language=pt-BR`);
    if (!response.ok) return null;
    const data = await response.json();
    return {
      title: data.title,
      poster: data.poster_path ? `https://image.tmdb.org/t/p/w500${data.poster_path}` : null
    };
  } catch (error) {
    console.error(`Error fetching TMDB data for ID ${tmdbId}:`, error);
    return null;
  }
}

async function getMovies() {
  try {
    const response = await fetch(RSS_URL);
    const xml = await response.text();
    const parser = new XMLParser({
      ignoreAttributes: false,
      attributeNamePrefix: "@_"
    });
    const result = parser.parse(xml);
    let items = result.rss.channel.item;

    if (!items) {
      return [];
    }

    if (!Array.isArray(items)) {
      items = [items];
    }

    const movies = await Promise.all(items.map(async (item: any) => {
      // Extract poster image from description HTML (fallback)
      const imgMatch = item.description.match(/src="([^"]+)"/);
      let poster = imgMatch ? imgMatch[1] : null;
      
      // Extract rating (if available)
      const ratingMatch = item.title.match(/[‚òÖ¬Ω]+/);
      const stars = ratingMatch ? ratingMatch[0] : '';
      const rating = item['letterboxd:memberRating'] || 0;
      
      // Check if liked
      const liked = item.description.includes('liked');

      // Get Portuguese title and poster if TMDB ID is present
      const tmdbId = item['tmdb:movieId'];
      let title = item.title.split(' - ')[0].split(',')[0]; // Default to RSS title
      
      if (tmdbId) {
        const tmdbData = await getTMDBData(tmdbId);
        if (tmdbData) {
          if (tmdbData.title) title = tmdbData.title;
          if (tmdbData.poster) poster = tmdbData.poster;
        }
      }
      
      const date = new Date(item['letterboxd:watchedDate'] || item.pubDate);

      return {
        title: title,
        link: item.link,
        stars: stars,
        rating: rating,
        liked: liked,
        date: date,
        year: date.getFullYear(),
        dateString: date.toLocaleDateString('pt-BR', { day: '2-digit', month: 'short' }).replace(' de ', ' ').replace('.', '').toUpperCase(),
        poster: poster
      };
    }));

    return movies;
  } catch (error) {
    console.error('Error fetching Letterboxd RSS:', error);
    return [];
  }
}

const movies = (await getMovies()).sort((a: any, b: any) => b.date - a.date);

// Helper to check if year should be shown (first occurrence of the year)
let lastYear: number | null = null;
function shouldShowYear(year: number) {
    if (year !== lastYear) {
        lastYear = year;
        return true;
    }
    return false;
}
---

<Layout title="Maitan Hub | Filmes">
  <nav slot="sidebar" class="flex flex-col space-y-3 text-sm text-neutral-500 dark:text-neutral-400">
    <a href="/observatorio" class="hover:text-black dark:hover:text-white transition-colors">in√≠cio</a>
    <a href="/observatorio/livros" class="hover:text-black dark:hover:text-white transition-colors">livros</a>
    <a href="/observatorio/filmes" class="text-black dark:text-white font-medium">filmes</a>
    <a href="/observatorio/citacoes" class="hover:text-black dark:hover:text-white transition-colors">cita√ß√µes</a>
    <a href="/observatorio/links" class="hover:text-black dark:hover:text-white transition-colors">links</a>
  </nav>

  <section class="space-y-8">
    <header class="space-y-4">
      <h1 class="text-3xl font-serif font-medium text-neutral-900 dark:text-neutral-100">Filmes</h1>
      <p class="text-neutral-600 dark:text-neutral-400 font-serif max-w-xl leading-relaxed">
        O que tenho assistido recentemente. Dados sincronizados do <a href="https://letterboxd.com/lmaitan/" target="_blank" class="underline decoration-neutral-300 dark:decoration-neutral-700 underline-offset-2 hover:text-black dark:hover:text-white transition-colors">Letterboxd</a>.
      </p>
    </header>

    <div class="space-y-0 relative">
      {movies.length === 0 ? (
        <div class="py-12 text-center border-y border-neutral-100 dark:border-neutral-800">
          <p class="text-neutral-400 dark:text-neutral-500 font-serif italic">
            Nenhum filme encontrado recentemente. <br/>
            <span class="text-sm not-italic mt-2 block">Talvez eu esteja assistindo algo agora mesmo... üçø</span>
          </p>
        </div>
      ) : (
        movies.map((movie: any, index: number) => {
            const showYear = index === 0 || movie.year !== movies[index - 1].year;
            
            return (
            <div class="relative group">
                <a href={movie.link} target="_blank" class="movie-link flex items-center py-4 border-b border-neutral-100 dark:border-neutral-800 hover:bg-neutral-50 dark:hover:bg-neutral-800/50 transition-colors -mx-4 px-4 rounded-none" data-poster={movie.poster}>
                
                <!-- Year (Left Column) -->
                <div class="w-16 flex-shrink-0 text-xs font-mono text-neutral-400 dark:text-neutral-500 font-bold">
                    {showYear && movie.year}
                </div>

                <!-- Date -->
                <div class="w-16 flex-shrink-0 text-xs font-mono text-neutral-400 dark:text-neutral-500">
                    {movie.dateString}
                </div>

                <!-- Title -->
                <div class="flex-grow min-w-0 pr-4">
                    <h3 class="text-lg font-medium text-neutral-900 dark:text-neutral-200 truncate">
                    {movie.title}
                    </h3>
                </div>

                <!-- Meta (Heart, Rating, Stars) -->
                <div class="flex items-center gap-4 flex-shrink-0">
                    <!-- Heart -->
                    <div class="w-4 h-4 flex items-center justify-center">
                        {movie.liked && (
                            <div class="text-red-500">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-4 h-4"><path d="m11.645 20.91-.007-.003-.022-.012a15.247 15.247 0 0 1-.383-.218 25.18 25.18 0 0 1-4.244-3.17C4.688 15.36 2.25 12.174 2.25 8.25 2.25 5.322 4.714 3 7.688 3A5.5 5.5 0 0 1 12 5.052 5.5 5.5 0 0 1 16.313 3c2.973 0 5.437 2.322 5.437 5.25 0 3.925-2.438 7.111-4.739 9.256a25.175 25.175 0 0 1-4.244 3.17 15.247 15.247 0 0 1-.383.219l-.022.012-.007.004-.003.001a.752.752 0 0 1-.704 0l-.003-.001Z" /></svg>
                            </div>
                        )}
                    </div>

                    <!-- Numeric Rating -->
                    <div class="text-xs font-mono text-neutral-400 dark:text-neutral-500 w-6 text-right">
                        {movie.rating > 0 ? movie.rating.toFixed(1) : '-'}
                    </div>

                    <!-- Stars -->
                    <div class="text-yellow-500 text-xs tracking-tighter w-16 text-right hidden sm:block">
                        {movie.stars}
                    </div>
                </div>
                </a>
            </div>
        )})
      )}
    </div>

    <!-- Floating Image Container -->
    <img id="movie-poster" src="" alt="" class="fixed pointer-events-none opacity-0 w-48 rounded-none shadow-2xl z-50 transition-opacity duration-200 object-cover aspect-[2/3] hidden" style="left: 0; top: 0;" />

  </section>
</Layout>

<script>
  const links = document.querySelectorAll('.movie-link');
  const poster = document.getElementById('movie-poster') as HTMLImageElement;
  let hideTimeout: any;

  links.forEach(link => {
    link.addEventListener('mouseenter', (e) => {
      const imgUrl = (link as HTMLElement).dataset.poster;
      if (imgUrl && poster) {
        // Clear any pending hide timeout
        if (hideTimeout) {
          clearTimeout(hideTimeout);
          hideTimeout = null;
        }

        poster.src = imgUrl;
        poster.classList.remove('hidden');
        // Small delay to allow src to load/browser to register before showing
        requestAnimationFrame(() => {
            poster.classList.remove('opacity-0');
        });
      }
    });

    link.addEventListener('mouseleave', () => {
      if (poster) {
        poster.classList.add('opacity-0');
        // Wait for transition to finish before hiding
        hideTimeout = setTimeout(() => {
            poster.classList.add('hidden');
        }, 200);
      }
    });

    link.addEventListener('mousemove', (e) => {
      if (poster) {
        const x = (e as MouseEvent).clientX;
        const y = (e as MouseEvent).clientY;
        
        // Offset the image so it doesn't cover the cursor
        const offsetX = 20;
        const offsetY = 20;

        poster.style.transform = `translate(${x + offsetX}px, ${y + offsetY}px)`;
      }
    });
  });
</script>
