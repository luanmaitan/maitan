---
import Layout from "../../layouts/Layout.astro";
import PageNav from "../../components/PageNav.astro";

const RSS_URL = "https://letterboxd.com/maitan/rss/";
// Using rss2json to avoid CORS/User-Agent blocking issues with direct RSS fetching
const PROXY_URL = `https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(RSS_URL)}`;

async function getMovies() {
  try {
    const response = await fetch(PROXY_URL);
    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

    const data = await response.json();

    if (!data.items || !Array.isArray(data.items)) {
      return [];
    }

    // Get TMDB data for better covers (simulated/extracted from description)
    const movies = data.items.map((item: any) => {
      // Extract rating
      const ratingMatch =
        item.description && item.description.match(/Stars: ([\d.]+) of 5/);
      const rating = ratingMatch ? parseFloat(ratingMatch[1]) : 0;
      const stars =
        "★".repeat(Math.floor(rating)) + (rating % 1 >= 0.5 ? "½" : "");

      // Extract original letterboxd poster to fallback
      // rss2json extracts images into 'thumbnail' or we parse description
      // Letterboxd RSS description contains HTML with img src
      const posterMatch =
        item.description && item.description.match(/src="([^"]+)"/);
      let poster = posterMatch ? posterMatch[1] : item.thumbnail || "";

      // Fix poster resolution if needed (Letterboxd RSS usually gives small thumbs, but we can try to replace /0- with /0-600-0-900-crop if predictable, but let's stick to what is given first)

      const date = new Date(item.pubDate);

      return {
        title: item.title ? item.title.replace(/ \(.*\)$/, "") : "Sem título", // Remove year from title
        link: item.link,
        rating: rating,
        stars: stars,
        date: date,
        dateString: date
          .toLocaleDateString("pt-BR", { day: "2-digit", month: "short" })
          .replace(" de ", " ")
          .replace(".", "")
          .toUpperCase(),
        year: date.getFullYear(),
        poster: poster,
        rewatch: item.description && item.description.includes("Rewatched"),
      };
    });

    return movies;
  } catch (error) {
    console.error("Error fetching Letterboxd RSS:", error);
    return [];
  }
}

const movies = (await getMovies()).sort((a: any, b: any) => b.date - a.date);
const currentPath = Astro.url.pathname;
---

<Layout title="Maitan Hub | Filmes">
  <!-- Sidebar removed -->

  <section class="space-y-8">
    <header>
      <h1
        class="text-4xl md:text-5xl lg:text-[60px] leading-[0.95] tracking-tight font-bold text-black dark:text-white mb-4 lowercase"
      >
        filmes
      </h1>
    </header>

    <PageNav
      items={[
        { label: "livros", href: "/observatorio/livros" },
        { label: "filmes", href: "/observatorio/filmes", active: true },
        { label: "citações", href: "/observatorio/citacoes" },
        { label: "links", href: "/observatorio/links" },
      ]}
    />

    <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4 md:gap-6">
      {
        movies.length === 0 ? (
          <div class="col-span-full py-12 text-center border-y border-neutral-100 dark:border-neutral-800">
            <p class="text-neutral-400 dark:text-neutral-500 italic">
              Nenhum filme encontrado recentemente.
            </p>
          </div>
        ) : (
          movies.map((movie: any, index: number) => (
            <a
              href={movie.link}
              target="_blank"
              class="group block relative aspect-[2/3] bg-neutral-100 dark:bg-neutral-800 overflow-hidden"
            >
              <div class="absolute top-2 right-2 z-10 text-[10px] font-mono text-white/80 drop-shadow-md">
                {String(index + 1).padStart(2, "0")}
              </div>
              <img
                src={movie.poster}
                alt={`Poster de ${movie.title}`}
                class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-105 opacity-90 group-hover:opacity-100"
                loading="lazy"
              />

              <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex flex-col justify-end p-4">
                <span class="text-yellow-400 text-xs tracking-widest mb-1">
                  {movie.stars}
                </span>
                <h3 class="text-white font-bold leading-tight text-sm line-clamp-2 tracking-tight">
                  {movie.title}
                </h3>
                <div class="flex justify-between items-center mt-2">
                  <span class="text-neutral-400 text-[10px]">
                    {movie.dateString}
                  </span>
                  {movie.rewatch && (
                    <span class="text-neutral-400 text-[10px]">↺</span>
                  )}
                </div>
              </div>
            </a>
          ))
        )
      }
    </div>
  </section>
</Layout>
