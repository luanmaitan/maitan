---
import Layout from '../../layouts/Layout.astro';
import { XMLParser } from 'fast-xml-parser';

const RSS_URL = 'https://www.goodreads.com/review/list_rss/9832371?key=NiGdczsTdllwXApQtXWgtYcYJQm2zi-PUMmv8iz7FwI-OpbO&shelf=read';

async function getBooks() {
  try {
    const response = await fetch(RSS_URL, {
        headers: {
            'User-Agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36'
        }
    });
    const xml = await response.text();
    const parser = new XMLParser({
      ignoreAttributes: false,
      attributeNamePrefix: "@_"
    });
    const result = parser.parse(xml);
    
    if (!result.rss || !result.rss.channel || !result.rss.channel.item) {
        return [];
    }

    let items = result.rss.channel.item;
    if (!Array.isArray(items)) {
      items = [items];
    }

    return items.map((item: any) => {
      const rating = parseInt(item.user_rating) || 0;
      const stars = '‚òÖ'.repeat(rating) + '¬Ω'.repeat(0); 
      
      const dateStr = item.user_read_at || item.user_date_added || item.pubDate;
      const date = new Date(dateStr);

      return {
        title: item.title,
        link: item.link,
        author: item.author_name,
        rating: rating,
        stars: '‚òÖ'.repeat(rating),
        date: date,
        year: date.getFullYear(),
        dateString: date.toLocaleDateString('pt-BR', { day: '2-digit', month: 'short' }).replace(' de ', ' ').replace('.', '').toUpperCase(),
        poster: item.book_large_image_url || item.book_image_url
      };
    });
  } catch (error) {
    console.error('Error fetching Goodreads RSS:', error);
    return [];
  }
}

const books = (await getBooks()).sort((a: any, b: any) => b.date - a.date);

let lastYear: number | null = null;
function shouldShowYear(year: number) {
    if (year !== lastYear) {
        lastYear = year;
        return true;
    }
    return false;
}

const currentPath = Astro.url.pathname;
---

<Layout title="Maitan Hub | Livros">
  <div slot="sidebar" class="w-full flex flex-col gap-8 md:flex-row md:items-center md:gap-6 lg:flex-col lg:items-start lg:gap-8">
    <nav class="flex flex-col gap-2 md:flex-row md:gap-6 lg:flex-col lg:gap-2 w-full md:w-auto">
        <a href="/observatorio" class="text-[15px] font-medium tracking-[-0.3px] text-neutral-500 hover:text-black dark:hover:text-white transition-colors lowercase mb-4 md:mb-0">
            ‚Üê voltar
        </a>

        {[
            { name: 'livros', href: '/observatorio/livros', count: books.length }, 
            { name: 'filmes', href: '/observatorio/filmes', count: '‚Äî' }, 
            { name: 'cita√ß√µes', href: '/observatorio/citacoes', count: '‚Äî' },
            { name: 'links', href: '/observatorio/links', count: '‚Äî' },
        ].map((item, i) => {
            const isActive = currentPath === item.href;
            return (
            <a
                href={item.href}
                class="group flex flex-col md:flex-row md:items-center md:gap-2 lg:flex-col lg:items-start lg:gap-0"
            >
                <span class:list={[
                    "text-[15px] font-medium lowercase leading-[18px] tracking-[-0.045px]",
                    isActive ? "text-black dark:text-white" : "text-neutral-500 dark:text-neutral-400 hover:text-black dark:hover:text-white"
                ]}>
                    <span class="text-[10px] text-neutral-300 dark:text-neutral-600 mr-1 font-mono">{String(i + 1).padStart(2, '0')}</span>
                    {item.name}
                </span>
                <span class="text-[12px] text-neutral-400 dark:text-neutral-600 group-hover:text-neutral-500 dark:group-hover:text-neutral-500 leading-tight mt-1 md:mt-0 md:ml-1 lg:mt-1 lg:ml-0 hidden lg:block">
                    {String(item.count).padStart(2, '0')}
                </span>
            </a>
        )})}
    </nav>
  </div>

  <section class="space-y-8">
    <header class="hidden lg:block">
      <h1 class="text-[60px] leading-[1.1] tracking-[-0.6px] font-medium text-black dark:text-white mb-4 lowercase">
        livros
      </h1>
      <p class="text-neutral-600 dark:text-neutral-400 leading-relaxed max-w-2xl">
        Minha estante virtual. Dados sincronizados do <a href="https://www.goodreads.com/user/show/9832371-maitan" target="_blank" class="underline decoration-neutral-300 dark:decoration-neutral-700 underline-offset-2 hover:text-black dark:hover:text-white transition-colors">Goodreads</a>.
      </p>
    </header>
    <header class="lg:hidden">
        <h1 class="text-3xl font-medium text-black dark:text-white lowercase leading-tight mb-2">livros</h1>
        <p class="text-sm text-neutral-600 dark:text-neutral-400 leading-relaxed">Minha estante virtual. Dados sincronizados do Goodreads.</p>
    </header>

    <div class="space-y-0 relative">
      {books.length === 0 ? (
        <div class="py-12 text-center border-y border-neutral-100 dark:border-neutral-800">
          <p class="text-neutral-400 dark:text-neutral-500 italic">
            Nenhum livro encontrado recentemente. <br/>
            <span class="text-sm not-italic mt-2 block">Hora de come√ßar uma nova leitura... üìö</span>
          </p>
        </div>
      ) : (
        books.map((book: any, index: number) => {
            const showYear = index === 0 || book.year !== books[index - 1].year;
            
            return (
            <div class="relative group">
                <a href={book.link} target="_blank" class="book-link flex items-center py-4 border-b border-neutral-100 dark:border-neutral-800 hover:bg-neutral-50 dark:hover:bg-neutral-800/50 transition-colors -mx-4 px-4 rounded-none" data-poster={book.poster}>
                
                <!-- Index Number -->
                <div class="hidden md:block w-8 flex-shrink-0 text-xs font-mono text-neutral-300 dark:text-neutral-600">
                    {String(index + 1).padStart(2, '0')}
                </div>

                <!-- Year (Left Column) -->
                <div class="w-16 flex-shrink-0 text-xs font-mono text-neutral-400 dark:text-neutral-500 font-bold">
                    {showYear && book.year}
                </div>

                <!-- Date -->
                <div class="w-16 flex-shrink-0 text-xs font-mono text-neutral-400 dark:text-neutral-500">
                    {book.dateString}
                </div>

                <!-- Title -->
                <div class="flex-grow min-w-0 pr-4">
                    <h3 class="text-lg font-medium text-neutral-900 dark:text-neutral-200 truncate lowercase">
                    {book.title}
                    </h3>
                    <p class="text-xs text-neutral-500 dark:text-neutral-400 md:hidden">
                        {book.author}
                    </p>
                </div>

                <!-- Author (Desktop) -->
                 <div class="hidden md:block w-48 flex-shrink-0 text-sm text-neutral-600 dark:text-neutral-400 truncate pr-4">
                    {book.author}
                </div>

                <!-- Meta (Rating, Stars) -->
                <div class="flex items-center gap-4 flex-shrink-0">
                    <!-- Numeric Rating -->
                    <div class="text-xs font-mono text-neutral-400 dark:text-neutral-500 w-6 text-right">
                        {book.rating > 0 ? book.rating : '-'}
                    </div>

                    <!-- Stars -->
                    <div class="text-yellow-500 text-xs tracking-tighter w-16 text-right hidden sm:block">
                        {book.stars}
                    </div>
                </div>
                </a>
            </div>
        )})
      )}
    </div>

    <!-- Floating Image Container -->
    <img id="book-poster" src="" alt="" class="fixed pointer-events-none opacity-0 w-32 rounded-r-md shadow-2xl z-50 transition-opacity duration-200 object-cover aspect-[2/3] hidden" style="left: 0; top: 0;" />

  </section>
</Layout>

<script>
  const links = document.querySelectorAll('.book-link');
  const poster = document.getElementById('book-poster') as HTMLImageElement;
  let hideTimeout: any;

  links.forEach(link => {
    link.addEventListener('mouseenter', (e) => {
      const imgUrl = (link as HTMLElement).dataset.poster;
      if (imgUrl && poster) {
        // Clear any pending hide timeout
        if (hideTimeout) {
          clearTimeout(hideTimeout);
          hideTimeout = null;
        }

        poster.src = imgUrl;
        poster.classList.remove('hidden');
        // Small delay to allow src to load/browser to register before showing
        requestAnimationFrame(() => {
            poster.classList.remove('opacity-0');
        });
      }
    });

    link.addEventListener('mouseleave', () => {
      if (poster) {
        poster.classList.add('opacity-0');
        // Wait for transition to finish before hiding
        hideTimeout = setTimeout(() => {
            poster.classList.add('hidden');
        }, 200);
      }
    });

    link.addEventListener('mousemove', (e) => {
      if (poster) {
        const x = (e as MouseEvent).clientX;
        const y = (e as MouseEvent).clientY;
        
        // Offset the image so it doesn't cover the cursor
        const offsetX = 20;
        const offsetY = 20;

        poster.style.transform = `translate(${x + offsetX}px, ${y + offsetY}px)`;
      }
    });
  });
</script>
