---
// Force dynamic rendering to handle query params
export const prerender = false;

import Layout from "../../layouts/Layout.astro";
import { getQuotes } from "../../lib/citacoes";

// Get query params
const tagParam = Astro.url.searchParams.get('tag');

// Carrega citações dos arquivos Markdown
const allQuotes = getQuotes();

// Filtra por tag se especificada
let quotes = allQuotes;
if (tagParam) {
    quotes = allQuotes.filter(quote => 
        quote.tags && Array.isArray(quote.tags) && quote.tags.includes(tagParam)
    );
}

// Extrai todas as tags únicas das citações filtradas para exibição
const availableTags = Array.from(
    new Set(quotes.flatMap(quote => quote.tags || []))
).sort();

// Helper para gerar URLs de filtro
function getFilterUrl(key: string, value: string | null) {
    const url = new URL(Astro.url);
    if (value === null) {
        url.searchParams.delete(key);
    } else {
        url.searchParams.set(key, value);
    }
    return url.pathname + (url.search || '');
}
---

<Layout title="Maitan Hub | Citações">
    <nav
        slot="sidebar"
        class="flex flex-col space-y-3 text-sm text-neutral-500 dark:text-neutral-400"
    >
        <a
            href="/observatorio"
            class="hover:text-black dark:hover:text-white transition-colors"
            >início</a
        >
        <a
            href="/observatorio/livros"
            class="hover:text-black dark:hover:text-white transition-colors"
            >livros</a
        >
        <a
            href="/observatorio/filmes"
            class="hover:text-black dark:hover:text-white transition-colors"
            >filmes</a
        >
        <a
            href="/observatorio/citacoes"
            class="text-black dark:text-white font-medium">citações</a
        >
        <a
            href="/observatorio/links"
            class="hover:text-black dark:hover:text-white transition-colors"
            >links</a
        >
    </nav>

    <section class="space-y-8">
        <section class="max-w-3xl mx-auto">
            <header class="mb-12 flex justify-between items-end">
                <div>
                    <h1 class="text-3xl font-serif italic mb-4">Citações</h1>
                    <p
                        class="text-neutral-600 dark:text-neutral-400 leading-relaxed"
                    >
                        Fragmentos, pensamentos e trechos coletados.
                    </p>
                </div>
                <button
                    id="random-btn"
                    class="px-4 py-2 text-sm font-medium bg-neutral-900 dark:bg-white text-white dark:text-black rounded-full hover:opacity-90 transition-opacity flex items-center gap-2"
                >
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        width="16"
                        height="16"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        ><path
                            d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"
                        ></path><path d="M3 3v5h5"></path><path
                            d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"
                        ></path><path d="M16 16h5v5"></path></svg
                    >
                    Aleatório
                </button>
            </header>

            <!-- Filters -->
            {availableTags.length > 0 && (
                <div class="mb-8 space-y-4 border-b border-neutral-100 dark:border-neutral-800 pb-6">
                    <div class="flex flex-wrap gap-2 items-center">
                        <span class="text-xs font-bold uppercase tracking-widest text-neutral-400 dark:text-neutral-500 mr-2">Tags:</span>
                        <a 
                            href={getFilterUrl('tag', null)} 
                            class={`text-[11px] uppercase tracking-wider border px-2 py-1 rounded-full transition-colors ${!tagParam ? 'border-neutral-900 dark:border-neutral-100 text-neutral-900 dark:text-neutral-100' : 'border-neutral-200 dark:border-neutral-800 hover:border-neutral-400 dark:hover:border-neutral-600 text-neutral-500 dark:text-neutral-400'}`}
                            data-filter-link
                        >
                            Todas
                        </a>
                        {availableTags.map(t => (
                            <a 
                                href={getFilterUrl('tag', t)} 
                                class={`text-[11px] uppercase tracking-wider border px-2 py-1 rounded-full transition-colors ${tagParam === t ? 'border-neutral-900 dark:border-neutral-100 text-neutral-900 dark:text-neutral-100' : 'border-neutral-200 dark:border-neutral-800 hover:border-neutral-400 dark:hover:border-neutral-600 text-neutral-500 dark:text-neutral-400'}`}
                                data-filter-link
                            >
                                {t}
                            </a>
                        ))}
                    </div>
                </div>
            )}

            <div id="quotes-grid" class="grid grid-cols-1 gap-6">
                {
                    quotes.map((quote) => (
                        <div class="quote-card p-8 bg-white dark:bg-neutral-900/50 border border-neutral-200 dark:border-neutral-800 rounded-none hover:border-neutral-400 dark:hover:border-neutral-600 transition-colors">
                            <blockquote class="font-serif text-xl leading-relaxed text-neutral-800 dark:text-neutral-200 mb-4 whitespace-pre-line">
                                {quote.text}
                            </blockquote>
                            <footer class="text-sm text-neutral-500 dark:text-neutral-400 font-mono mb-3">
                                — {quote.author}
                                {quote.source && (
                                    <span class="opacity-60">
                                        , em {quote.source}
                                    </span>
                                )}
                            </footer>
                            {quote.tags && quote.tags.length > 0 && (
                                <div class="flex flex-wrap gap-2 mt-3">
                                    {quote.tags.map(tag => (
                                        <a 
                                            href={getFilterUrl('tag', tag)}
                                            class="text-[10px] uppercase tracking-wider text-neutral-400 dark:text-neutral-500 border border-neutral-200 dark:border-neutral-800 px-1.5 py-0.5 rounded-full hover:border-neutral-400 dark:hover:border-neutral-600 transition-colors"
                                            data-filter-link
                                        >
                                            {tag}
                                        </a>
                                    ))}
                                </div>
                            )}
                        </div>
                    ))
                }
            </div>
        </section>
    </section>

    <script>
        const quotes = document.querySelectorAll(".quote-card");
        const btn = document.getElementById("random-btn");
        const grid = document.getElementById("quotes-grid");

        btn?.addEventListener("click", () => {
            if (!grid) return;

            const array = Array.from(quotes);
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }

            // Clear and re-append
            // Add a small fade animation
            grid.style.opacity = "0";
            setTimeout(() => {
                array.forEach((card) => grid.appendChild(card));
                grid.style.opacity = "1";
            }, 200);
        });

        // Force full page reload for filter links
        document.querySelectorAll('[data-filter-link]').forEach(filterLink => {
            filterLink.addEventListener('click', (e) => {
                e.preventDefault();
                const href = filterLink.getAttribute('href');
                if (href) {
                    window.location.href = href;
                }
            });
        });
    </script>

    <style>
        #quotes-grid {
            transition: opacity 0.2s ease-in-out;
        }
    </style>
</Layout>
