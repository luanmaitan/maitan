---
import Layout from '../../layouts/Layout.astro';
import { getCollections, getRaindrops, type Collection, type Raindrop } from '../../lib/raindrop';

const collections = await getCollections();
const allRaindrops = await getRaindrops(0); // 0 means all

// Process raindrops to include collection info and clean data
const links = allRaindrops.map((item) => {
  const collection = collections.find(c => c._id === item.collectionId);
  const date = new Date(item.created);
  
  return {
    ...item,
    collectionName: collection?.title || 'Uncategorized',
    collectionColor: collection?.color || '#666666', // Default gray
    collectionCover: collection?.cover?.[0] || null,
    date: date,
    year: date.getFullYear(),
    dateString: date.toLocaleDateString('pt-BR', { day: '2-digit', month: 'short' }).replace(' de ', ' ').replace('.', '').toUpperCase(),
  };
}).sort((a, b) => b.date.getTime() - a.date.getTime());

// Extract unique tags
const allTags = Array.from(new Set(links.flatMap(link => link.tags))).sort();

// Group by year for the list
let lastYear: number | null = null;
function shouldShowYear(year: number) {
    if (year !== lastYear) {
        lastYear = year;
        return true;
    }
    return false;
}
---

<Layout title="Maitan Hub | Links">
  <nav slot="sidebar" class="flex flex-col space-y-3 text-sm text-neutral-500 dark:text-neutral-400">
    <a href="/observatorio" class="hover:text-black dark:hover:text-white transition-colors">início</a>
    <a href="/observatorio/livros" class="hover:text-black dark:hover:text-white transition-colors">livros</a>
    <a href="/observatorio/filmes" class="hover:text-black dark:hover:text-white transition-colors">filmes</a>
    <a href="/observatorio/citacoes" class="hover:text-black dark:hover:text-white transition-colors">citações</a>
    <a href="/observatorio/links" class="text-black dark:text-white font-medium">links</a>
  </nav>

  <section class="space-y-8">
    <header class="space-y-4">
      <h1 class="text-3xl font-serif font-medium text-neutral-900 dark:text-neutral-100">Links</h1>
      <p class="text-neutral-600 dark:text-neutral-400 font-serif max-w-xl leading-relaxed">
        Uma curadoria de referências, artigos e ferramentas que encontro pela web. Sincronizado via <a href="https://raindrop.io/" target="_blank" class="underline decoration-neutral-300 dark:decoration-neutral-700 underline-offset-2 hover:text-black dark:hover:text-white transition-colors">Raindrop.io</a>.
      </p>
    </header>

    <!-- Filters (Top) -->
    <div class="space-y-6 border-b border-neutral-100 dark:border-neutral-800 pb-8">
        
        <!-- Quick Filters -->
        <div class="flex flex-wrap gap-2 items-center">
            <span class="text-xs font-bold uppercase tracking-widest text-neutral-400 dark:text-neutral-500 mr-2">Filtros:</span>
            
            <button class="filter-btn active px-3 py-1.5 rounded-full text-sm transition-all hover:bg-neutral-100 dark:hover:bg-neutral-800 flex items-center gap-2 text-neutral-900 dark:text-neutral-200 border border-transparent" data-filter="all">
                Todos
                <span class="text-xs text-neutral-400 dark:text-neutral-500 ml-1">{links.length}</span>
            </button>

            <button class="filter-btn px-3 py-1.5 rounded-full text-sm transition-all hover:bg-neutral-100 dark:hover:bg-neutral-800 flex items-center gap-2 text-neutral-600 dark:text-neutral-400 border border-transparent" data-filter="important">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4 text-red-500"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
                Favoritos
                <span class="text-xs text-neutral-400 dark:text-neutral-500 ml-1">{links.filter(l => l.important).length}</span>
            </button>

            <button class="filter-btn px-3 py-1.5 rounded-full text-sm transition-all hover:bg-neutral-100 dark:hover:bg-neutral-800 flex items-center gap-2 text-neutral-600 dark:text-neutral-400 border border-transparent" data-filter="type-link">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg>
                Links
                <span class="text-xs text-neutral-400 dark:text-neutral-500 ml-1">{links.filter(l => l.type === 'link').length}</span>
            </button>

            <button class="filter-btn px-3 py-1.5 rounded-full text-sm transition-all hover:bg-neutral-100 dark:hover:bg-neutral-800 flex items-center gap-2 text-neutral-600 dark:text-neutral-400 border border-transparent" data-filter="type-article">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                Artigos
                <span class="text-xs text-neutral-400 dark:text-neutral-500 ml-1">{links.filter(l => l.type === 'article').length}</span>
            </button>

            <button class="filter-btn px-3 py-1.5 rounded-full text-sm transition-all hover:bg-neutral-100 dark:hover:bg-neutral-800 flex items-center gap-2 text-neutral-600 dark:text-neutral-400 border border-transparent" data-filter="type-video">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4"><polygon points="23 7 16 12 23 17 23 7"></polygon><rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect></svg>
                Vídeos
                <span class="text-xs text-neutral-400 dark:text-neutral-500 ml-1">{links.filter(l => l.type === 'video').length}</span>
            </button>

             <button class="filter-btn px-3 py-1.5 rounded-full text-sm transition-all hover:bg-neutral-100 dark:hover:bg-neutral-800 flex items-center gap-2 text-neutral-600 dark:text-neutral-400 border border-transparent" data-filter="type-image">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>
                Imagens
                <span class="text-xs text-neutral-400 dark:text-neutral-500 ml-1">{links.filter(l => l.type === 'image').length}</span>
            </button>

            <button class="filter-btn px-3 py-1.5 rounded-full text-sm transition-all hover:bg-neutral-100 dark:hover:bg-neutral-800 flex items-center gap-2 text-neutral-600 dark:text-neutral-400 border border-transparent" data-filter="no-tags">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4"><line x1="4" y1="9" x2="20" y2="9"></line><line x1="4" y1="15" x2="20" y2="15"></line><line x1="10" y1="3" x2="8" y2="21"></line><line x1="16" y1="3" x2="14" y2="21"></line></svg>
                Sem tags
                <span class="text-xs text-neutral-400 dark:text-neutral-500 ml-1">{links.filter(l => l.tags.length === 0).length}</span>
            </button>
        </div>

        <!-- Collections -->
        <div class="flex flex-wrap gap-2 items-center">
            <span class="text-xs font-bold uppercase tracking-widest text-neutral-400 dark:text-neutral-500 mr-2">Pastas:</span>
            <button class="filter-btn active px-3 py-1.5 rounded-full text-sm transition-all hover:bg-neutral-100 dark:hover:bg-neutral-800 flex items-center gap-2 text-neutral-900 dark:text-neutral-200 border border-transparent" data-filter="all">
                <span class="w-2 h-2 rounded-full bg-neutral-400"></span>
                Todos
            </button>
            {collections.map(collection => (
            <button class="filter-btn px-3 py-1.5 rounded-full text-sm transition-all hover:bg-neutral-100 dark:hover:bg-neutral-800 flex items-center gap-2 text-neutral-600 dark:text-neutral-400 border border-transparent" data-filter={`collection-${collection._id}`}>
                {collection.cover?.[0] ? (
                    <img src={collection.cover[0]} alt="" class="w-4 h-4 object-contain" />
                ) : (
                    <span class="w-2 h-2 rounded-full" style={`background-color: ${collection.color || '#666666'}`}></span>
                )}
                {collection.title}
            </button>
        ))}
        </div>

        <!-- Tags -->
        <div class="flex flex-wrap gap-2 items-center">
            <span class="text-xs font-bold uppercase tracking-widest text-neutral-400 dark:text-neutral-500 mr-2">Tags:</span>
            {allTags.map(tag => (
                <button class="filter-btn text-[11px] uppercase tracking-wider border border-neutral-200 dark:border-neutral-800 px-2 py-1 rounded-full hover:border-neutral-400 dark:hover:border-neutral-600 transition-colors text-neutral-500 dark:text-neutral-400" data-filter={`tag-${tag}`}>
                    {tag}
                </button>
            ))}
        </div>
    </div>

    <!-- Main Content (List) -->
    <div class="space-y-0 relative min-h-[50vh]">
      {links.length === 0 ? (
        <div class="py-12 text-center border-y border-neutral-100 dark:border-neutral-800">
          <p class="text-neutral-400 dark:text-neutral-500 font-serif italic">
            Nenhum link encontrado.
          </p>
        </div>
      ) : (
        links.map((link, index) => {
            const showYear = index === 0 || link.year !== links[index - 1].year;
            
            return (
            <div class="relative group link-row" 
                 data-collection={`collection-${link.collectionId}`} 
                 data-tags={link.tags.map(t => `tag-${t}`).join(' ')}
                 data-type={`type-${link.type}`}
                 data-important={link.important ? 'important' : ''}
                 data-no-tags={link.tags.length === 0 ? 'no-tags' : ''}
            >
                <a href={link.link} target="_blank" class="link-item flex items-center py-4 border-b border-neutral-100 dark:border-neutral-800 hover:bg-neutral-50 dark:hover:bg-neutral-800/50 transition-colors -mx-4 px-4 rounded-lg" data-image={link.cover}>
                
                <!-- Year (Left Column) -->
                <div class="w-16 flex-shrink-0 text-xs font-mono text-neutral-400 dark:text-neutral-500 font-bold">
                    {showYear && link.year}
                </div>

                <!-- Date -->
                <div class="w-16 flex-shrink-0 text-xs font-mono text-neutral-400 dark:text-neutral-500">
                    {link.dateString}
                </div>

                <!-- Title & Tags -->
                <div class="flex-grow min-w-0 pr-4">
                    <div class="flex items-baseline gap-3">
                        <h3 class="text-lg font-medium text-neutral-900 dark:text-neutral-200 truncate">
                        {link.title}
                        </h3>
                        
                        <!-- Tags (Desktop) -->
                        <div class="hidden sm:flex gap-2">
                            {link.tags.map((tag) => (
                                <span class="text-[10px] uppercase tracking-wider text-neutral-400 dark:text-neutral-500 border border-neutral-200 dark:border-neutral-800 px-1.5 py-0.5 rounded-full">{tag}</span>
                            ))}
                        </div>
                    </div>
                    <p class="text-sm text-neutral-500 dark:text-neutral-400 truncate mt-1 max-w-2xl">
                        {link.description}
                    </p>
                     <!-- Tags (Mobile) -->
                    <div class="flex sm:hidden gap-2 mt-2 overflow-x-auto pb-1">
                        {link.tags.map((tag) => (
                            <span class="text-[10px] uppercase tracking-wider text-neutral-400 dark:text-neutral-500 border border-neutral-200 dark:border-neutral-800 px-1.5 py-0.5 rounded-full whitespace-nowrap">{tag}</span>
                        ))}
                    </div>
                </div>

                <!-- Collection Dot/Icon -->
                <div class="text-neutral-300 dark:text-neutral-700 group-hover:text-neutral-500 dark:group-hover:text-neutral-400 transition-colors" title={link.collectionName}>
                    {link.collectionCover ? (
                        <img src={link.collectionCover} alt="" class="w-4 h-4 object-contain opacity-70 group-hover:opacity-100 transition-opacity" />
                    ) : (
                        <span class="w-2 h-2 rounded-full block" style={`background-color: ${link.collectionColor}`}></span>
                    )}
                </div>

                </a>
            </div>
        )})
      )}
    </div>

    <!-- Floating Image Container -->
    <img id="link-image" src="" alt="" class="fixed pointer-events-none opacity-0 w-64 rounded-lg shadow-2xl z-50 transition-opacity duration-200 object-cover aspect-video hidden border border-neutral-200 dark:border-neutral-800 bg-white dark:bg-neutral-900" style="left: 0; top: 0;" />

  </section>
</Layout>

<script>
  // Hover Animation Logic
  const links = document.querySelectorAll('.link-item');
  const image = document.getElementById('link-image') as HTMLImageElement;
  let hideTimeout: any;

  links.forEach(link => {
    link.addEventListener('mouseenter', (e) => {
      const imgUrl = (link as HTMLElement).dataset.image;
      if (imgUrl && image) {
        if (hideTimeout) {
          clearTimeout(hideTimeout);
          hideTimeout = null;
        }
        image.src = imgUrl;
        image.classList.remove('hidden');
        requestAnimationFrame(() => {
            image.classList.remove('opacity-0');
        });
      }
    });

    link.addEventListener('mouseleave', () => {
      if (image) {
        image.classList.add('opacity-0');
        hideTimeout = setTimeout(() => {
            image.classList.add('hidden');
        }, 200);
      }
    });

    link.addEventListener('mousemove', (e) => {
      if (image) {
        const x = (e as MouseEvent).clientX;
        const y = (e as MouseEvent).clientY;
        const offsetX = 20;
        const offsetY = 20;
        image.style.transform = `translate(${x + offsetX}px, ${y + offsetY}px)`;
      }
    });
  });

  // Filtering Logic
  const filterBtns = document.querySelectorAll('.filter-btn');
  const linkRows = document.querySelectorAll('.link-row');

  filterBtns.forEach(btn => {
    btn.addEventListener('click', () => {
        // Remove active class from all
        filterBtns.forEach(b => {
            b.classList.remove('active', 'bg-neutral-100', 'dark:bg-neutral-800', 'text-neutral-900', 'dark:text-neutral-200', 'font-medium');
            b.classList.add('text-neutral-600', 'dark:text-neutral-400');
        });
        
        // Add active class to clicked
        btn.classList.add('active', 'bg-neutral-100', 'dark:bg-neutral-800', 'text-neutral-900', 'dark:text-neutral-200', 'font-medium');
        btn.classList.remove('text-neutral-600', 'dark:text-neutral-400');

        const filter = (btn as HTMLElement).dataset.filter;

        linkRows.forEach(row => {
            const el = row as HTMLElement;
            if (filter === 'all') {
                el.style.display = 'block';
            } else {
                const collectionMatch = el.dataset.collection === filter;
                const tagMatch = el.dataset.tags?.includes(filter || '');
                const typeMatch = el.dataset.type === filter;
                const importantMatch = filter === 'important' && el.dataset.important === 'important';
                const noTagsMatch = filter === 'no-tags' && el.dataset.noTags === 'no-tags';
                
                if (collectionMatch || tagMatch || typeMatch || importantMatch || noTagsMatch) {
                    el.style.display = 'block';
                } else {
                    el.style.display = 'none';
                }
            }
        });
    });
  });
</script>
