---
// Force dynamic rendering to handle query params
export const prerender = false;

import Layout from '../../layouts/Layout.astro';
import { getCollections, getRaindrops, type Collection, type Raindrop } from '../../lib/raindrop';

// Get query params
console.log('[Links] Full URL:', Astro.url.toString());
console.log('[Links] Search params:', Astro.url.searchParams.toString());
console.log('[Links] All search params:', Object.fromEntries(Astro.url.searchParams.entries()));

const collectionIdParam = Astro.url.searchParams.get('collection');
const tag = Astro.url.searchParams.get('tag');
const type = Astro.url.searchParams.get('type');
const important = Astro.url.searchParams.get('important') === 'true';
const noTags = Astro.url.searchParams.get('no-tags') === 'true';

console.log('[Links] Query params:', { collectionIdParam, tag, type, important, noTags });

// Default to "Todos" (0) if no collection param is present
const collectionId = parseInt(collectionIdParam || '0');
console.log('[Links] Using collectionId:', collectionId);

// Build search query for Raindrop API (only for supported filters)
// Note: Raindrop API search syntax may vary, so we'll also filter client-side
// Syntax: #tag type:article important:true
const searchParts: string[] = [];
if (tag) searchParts.push(`#${tag}`);
if (type) searchParts.push(`type:${type}`);
if (important) searchParts.push('important:true');
const searchQuery = searchParts.join(' ');

// Fetch data
const collections = await getCollections() || [];
console.log(`[Links] Found ${collections.length} collections`);

// Always fetch from collection 0 (all collections) and filter client-side
// This ensures filters work correctly regardless of collection
let raindrops: Raindrop[] = [];
raindrops = await getRaindrops(0, undefined) || [];
console.log(`[Links] Fetched ${raindrops.length} raindrops from API`);

// Process raindrops
let allLinks = raindrops
  .filter(item => item && item.title && item.link) // Filter out invalid items
  .map((item) => {
    const collection = collections.find(c => c._id === item.collectionId);
    const date = item.created ? new Date(item.created) : new Date();
    const tags = Array.isArray(item.tags) ? item.tags : [];
    
    return {
      ...item,
      tags: tags,
      collectionName: collection?.title || 'Uncategorized',
      collectionColor: collection?.color || '#666666',
      collectionCover: collection?.cover?.[0] || null,
      date: date,
      year: date.getFullYear(),
      dateString: date.toLocaleDateString('pt-BR', { day: '2-digit', month: 'short' }).replace(' de ', ' ').replace('.', '').toUpperCase(),
    };
  });

// Apply client-side filters to ensure they work correctly
let links = allLinks;
console.log(`[Links] Before filtering: ${links.length} links`);

// Filter by collection (if not "all")
if (collectionId !== 0) {
  const before = links.length;
  links = links.filter(link => link.collectionId === collectionId);
  console.log(`[Links] After collection filter (${collectionId}): ${before} -> ${links.length}`);
}

// Filter by tag
if (tag) {
  const before = links.length;
  links = links.filter(link => link.tags && Array.isArray(link.tags) && link.tags.includes(tag));
  console.log(`[Links] After tag filter (${tag}): ${before} -> ${links.length}`);
}

// Filter by type
if (type) {
  const before = links.length;
  links = links.filter(link => link.type === type);
  console.log(`[Links] After type filter (${type}): ${before} -> ${links.length}`);
}

// Filter by important
if (important) {
  const before = links.length;
  links = links.filter(link => link.important === true);
  console.log(`[Links] After important filter: ${before} -> ${links.length}`);
}

// Filter by no tags
if (noTags) {
  const before = links.length;
  links = links.filter(link => !link.tags || !Array.isArray(link.tags) || link.tags.length === 0);
  console.log(`[Links] After noTags filter: ${before} -> ${links.length}`);
}

console.log(`[Links] Final filtered links: ${links.length}`);

// Sort by date (newest first)
links.sort((a, b) => b.date.getTime() - a.date.getTime());

// Extract unique tags from filtered links for display
const currentTags = Array.from(new Set(links.flatMap(link => link.tags || []))).sort();

// Group by year
let lastYear: number | null = null;
function shouldShowYear(year: number) {
    if (year !== lastYear) {
        lastYear = year;
        return true;
    }
    return false;
}

// Collection Icons Mapping
const collectionIcons: Record<number, string> = {
    63393704: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>', // Pessoas
    63389665: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>', // Artigos
    63467072: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4"><polygon points="23 7 16 12 23 17 23 7"></polygon><rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect></svg>', // Vídeos
    63467000: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>', // Design
    63427284: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4"><path d="M9 18V5l12-2v13"></path><circle cx="6" cy="18" r="3"></circle><circle cx="18" cy="16" r="3"></circle></svg>', // Áudio
    63466904: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg>', // Revistas
    63466990: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>', // Galeria
    63467129: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4"><polyline points="16 18 22 12 16 6"></polyline><polyline points="8 6 2 12 8 18"></polyline></svg>', // Repos
    63481388: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>', // Orgs
    63397282: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4"><path d="M10 2v7.31"></path><path d="M14 2v7.31"></path><path d="M8.5 2h7"></path><path d="M14 9.3a6.5 6.5 0 1 1-4 0"></path></svg>', // Experimentos
    63395245: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>', // Extraordinários
    63466532: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4"><polyline points="21 8 21 21 3 21 3 8"></polyline><rect x="1" y="3" width="22" height="5"></rect><line x1="10" y1="12" x2="14" y2="12"></line></svg>', // Importados
    63466588: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4"><polyline points="21 8 21 21 3 21 3 8"></polyline><rect x="1" y="3" width="22" height="5"></rect><line x1="10" y1="12" x2="14" y2="12"></line></svg>', // Arquivo Final
};

const defaultIcon = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg>';

// Helper to generate filter URLs
function getFilterUrl(key: string, value: string | null) {
    const url = new URL(Astro.url);
    if (value === null) {
        url.searchParams.delete(key);
    } else {
        url.searchParams.set(key, value);
    }
    // Preserve all other query params
    const result = url.pathname + (url.search || '');
    return result;
}

// Helper to add data-astro-reload to force full page reload
function getFilterUrlWithReload(key: string, value: string | null) {
    return getFilterUrl(key, value);
}
---

<Layout title="Maitan Hub | Links">
  <nav slot="sidebar" class="flex flex-col space-y-3 text-sm text-neutral-500 dark:text-neutral-400">
    <a href="/observatorio" class="hover:text-black dark:hover:text-white transition-colors">início</a>
    <a href="/observatorio/livros" class="hover:text-black dark:hover:text-white transition-colors">livros</a>
    <a href="/observatorio/filmes" class="hover:text-black dark:hover:text-white transition-colors">filmes</a>
    <a href="/observatorio/citacoes" class="hover:text-black dark:hover:text-white transition-colors">citações</a>
    <a href="/observatorio/links" class="text-black dark:text-white font-medium">links</a>
  </nav>

  <section class="space-y-8">
    <header class="space-y-4">
      <h1 class="text-3xl font-serif font-medium text-neutral-900 dark:text-neutral-100">Links</h1>
      <p class="text-neutral-600 dark:text-neutral-400 font-serif max-w-xl leading-relaxed">
        Uma curadoria de referências, artigos e ferramentas que encontro pela web. Sincronizado via <a href="https://raindrop.io/" target="_blank" class="underline decoration-neutral-300 dark:decoration-neutral-700 underline-offset-2 hover:text-black dark:hover:text-white transition-colors">Raindrop.io</a>.
      </p>
    </header>

    <!-- Filters (Top) -->
    <div class="space-y-6 border-b border-neutral-100 dark:border-neutral-800 pb-8">
        
        <!-- Collections -->
        <div class="flex flex-wrap gap-2 items-center">
            <span class="text-xs font-bold uppercase tracking-widest text-neutral-400 dark:text-neutral-500 mr-2">Pastas:</span>
            <a href={getFilterUrl('collection', '0')} class={`filter-link px-3 py-1.5 rounded-full text-sm transition-all hover:bg-neutral-100 dark:hover:bg-neutral-800 flex items-center gap-2 border border-transparent ${collectionId === 0 ? 'bg-neutral-100 dark:bg-neutral-800 text-neutral-900 dark:text-neutral-200 font-medium' : 'text-neutral-600 dark:text-neutral-400'}`}>
                <span class="w-2 h-2 rounded-full bg-neutral-400"></span>
                Todos
            </a>
            {collections.map(collection => {
                const isActive = collectionId === collection._id;
                return (
                <a href={getFilterUrl('collection', collection._id.toString())} class={`filter-link px-3 py-1.5 rounded-full text-sm transition-all hover:bg-neutral-100 dark:hover:bg-neutral-800 flex items-center gap-2 border border-transparent ${isActive ? 'bg-neutral-100 dark:bg-neutral-800 text-neutral-900 dark:text-neutral-200 font-medium' : 'text-neutral-600 dark:text-neutral-400'}`}>
                    {collection.cover?.[0] ? (
                        <img src={collection.cover[0]} alt="" class="w-4 h-4 object-contain" />
                    ) : (
                        <span class="w-2 h-2 rounded-full" style={`background-color: ${collection.color || '#666666'}`}></span>
                    )}
                    {collection.title}
                </a>
            )})}
        </div>

        <!-- Tags (Current Page Only) -->
        {currentTags.length > 0 && (
        <div class="flex flex-wrap gap-2 items-center">
            <span class="text-xs font-bold uppercase tracking-widest text-neutral-400 dark:text-neutral-500 mr-2">Tags:</span>
            {currentTags.map(t => (
                <a href={getFilterUrl('tag', t)} class={`filter-link text-[11px] uppercase tracking-wider border px-2 py-1 rounded-full transition-colors ${tag === t ? 'border-neutral-900 dark:border-neutral-100 text-neutral-900 dark:text-neutral-100' : 'border-neutral-200 dark:border-neutral-800 hover:border-neutral-400 dark:hover:border-neutral-600 text-neutral-500 dark:text-neutral-400'}`}>
                    {t}
                </a>
            ))}
        </div>
        )}
    </div>

    <!-- Main Content (List) -->
    <div class="space-y-0 relative min-h-[50vh]">
      {links.length === 0 ? (
        <div class="py-12 text-center border-y border-neutral-100 dark:border-neutral-800">
          <p class="text-neutral-400 dark:text-neutral-500 font-serif italic">
            Nenhum link encontrado.
          </p>
        </div>
      ) : (
        links.map((link, index) => {
            const showYear = index === 0 || link.year !== links[index - 1].year;
            
            return (
            <div class="relative group link-row">
                <a href={link.link} target="_blank" class="link-item flex items-center py-4 border-b border-neutral-100 dark:border-neutral-800 hover:bg-neutral-50 dark:hover:bg-neutral-800/50 transition-colors -mx-4 px-4 rounded-none" data-image={link.cover}>
                
                <!-- Year (Left Column) -->
                <div class="w-16 flex-shrink-0 text-xs font-mono text-neutral-400 dark:text-neutral-500 font-bold">
                    {showYear && link.year}
                </div>

                <!-- Date -->
                <div class="w-16 flex-shrink-0 text-xs font-mono text-neutral-400 dark:text-neutral-500">
                    {link.dateString}
                </div>

                <!-- Title & Tags -->
                <div class="flex-grow min-w-0 pr-4">
                    <div class="flex items-baseline gap-3">
                        <h3 class="text-lg font-medium text-neutral-900 dark:text-neutral-200 truncate">
                        {link.title}
                        </h3>
                        
                        <!-- Tags (Desktop) -->
                        <div class="hidden sm:flex gap-2">
                            {link.tags.map((t) => (
                                <span class="text-[10px] uppercase tracking-wider text-neutral-400 dark:text-neutral-500 border border-neutral-200 dark:border-neutral-800 px-1.5 py-0.5 rounded-full">{t}</span>
                            ))}
                        </div>
                    </div>
                    <p class="text-sm text-neutral-500 dark:text-neutral-400 truncate mt-1 max-w-2xl">
                        {link.description}
                    </p>
                     <!-- Tags (Mobile) -->
                    <div class="flex sm:hidden gap-2 mt-2 overflow-x-auto pb-1">
                        {link.tags.map((t) => (
                            <span class="text-[10px] uppercase tracking-wider text-neutral-400 dark:text-neutral-500 border border-neutral-200 dark:border-neutral-800 px-1.5 py-0.5 rounded-full whitespace-nowrap">{t}</span>
                        ))}
                    </div>
                </div>

                <!-- Collection Dot/Icon -->
                <div class="text-neutral-300 dark:text-neutral-700 group-hover:text-neutral-500 dark:group-hover:text-neutral-400 transition-colors" title={link.collectionName}>
                    {link.collectionCover ? (
                        <img src={link.collectionCover} alt="" class="w-4 h-4 object-contain opacity-70 group-hover:opacity-100 transition-opacity" />
                    ) : (
                        <span class="w-2 h-2 rounded-full block" style={`background-color: ${link.collectionColor}`}></span>
                    )}
                </div>

                </a>
            </div>
        )})
      )}
    </div>



    <!-- Floating Image Container -->
    <img id="link-image" src="" alt="" class="fixed pointer-events-none opacity-0 w-64 rounded-lg shadow-2xl z-50 transition-opacity duration-200 object-cover aspect-video hidden border border-neutral-200 dark:border-neutral-800 bg-white dark:bg-neutral-900" style="left: 0; top: 0;" />

  </section>
</Layout>

<script>
  // Force full page reload on filter links
  document.addEventListener('DOMContentLoaded', () => {
    const filterLinks = document.querySelectorAll('.filter-link');
    filterLinks.forEach(link => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        const href = (link as HTMLAnchorElement).href;
        window.location.href = href;
      });
    });
  });

  // Hover Animation Logic
  document.addEventListener('DOMContentLoaded', () => {
    const links = document.querySelectorAll('.link-item');
    const image = document.getElementById('link-image') as HTMLImageElement | null;
    let hideTimeout: any;

    if (!image) return;

    links.forEach(link => {
      link.addEventListener('mouseenter', (e) => {
        const imgUrl = (link as HTMLElement).dataset.image;
        if (imgUrl && image) {
          if (hideTimeout) {
            clearTimeout(hideTimeout);
            hideTimeout = null;
          }
          image.src = imgUrl;
          image.classList.remove('hidden');
          requestAnimationFrame(() => {
            if (image) {
              image.classList.remove('opacity-0');
            }
          });
        }
      });

      link.addEventListener('mouseleave', () => {
        if (image) {
          image.classList.add('opacity-0');
          hideTimeout = setTimeout(() => {
            if (image) {
              image.classList.add('hidden');
            }
          }, 200);
        }
      });

      link.addEventListener('mousemove', (e) => {
        if (image) {
          const x = (e as MouseEvent).clientX;
          const y = (e as MouseEvent).clientY;
          const offsetX = 20;
          const offsetY = 20;
          image.style.transform = `translate(${x + offsetX}px, ${y + offsetY}px)`;
        }
      });
    });
  });
</script>
