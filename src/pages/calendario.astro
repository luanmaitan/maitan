---
import Layout from "../layouts/Layout.astro";
import {
    getEvents,
    formatEventForCalendar,
    CATEGORIES,
} from "../lib/calendario";

// Carrega eventos
const events = getEvents();
const formattedEvents = events.map(formatEventForCalendar);
---

<!-- Carrega FullCalendar Global Bundle (solução mais robusta para evitar problemas de bundler client-side) -->
<script
    is:inline
    src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"
></script>

<Layout title="Maitan Hub | Calendário">
    <!-- Sidebar Slot: Filtros -->
    <!-- Sidebar removed -->

    <!-- Main Content -->
    <section class="h-full min-h-[700px] flex flex-col gap-8 relative">
        <header class="space-y-4">
            <h1
                class="text-[60px] leading-[0.95] tracking-tighter font-black text-black dark:text-white mb-4 lowercase"
            >
                calendário
            </h1>

            <!-- Filtros (Moved from Sidebar) -->
            <div class="pt-4">
                <div class="flex flex-wrap gap-2 items-center">
                    <button
                        id="filter-all"
                        class="px-3 py-1.5 rounded-full text-sm transition-all hover:bg-neutral-100 dark:hover:bg-neutral-800 border border-transparent bg-neutral-100 dark:bg-neutral-800 text-neutral-900 dark:text-neutral-200 font-medium filter-btn active whitespace-nowrap"
                        data-category="all"
                    >
                        Todas
                    </button>
                    {
                        Object.entries(CATEGORIES).map(([key, category]) => (
                            <button
                                class="px-3 py-1.5 rounded-full text-sm transition-all hover:bg-neutral-100 dark:hover:bg-neutral-800 flex items-center gap-2 border border-transparent filter-btn whitespace-nowrap"
                                data-category={key}
                                style={`--category-color: ${category.color}`}
                            >
                                <span
                                    class="w-2 h-2 rounded-full shrink-0"
                                    style={`background-color: ${category.color}`}
                                />
                                {category.name}
                            </button>
                        ))
                    }
                </div>
            </div>
        </header>

        <!-- Calendário Wrapper -->
        <div
            class="w-full bg-white dark:bg-neutral-900 border border-neutral-200 dark:border-neutral-800 rounded-sm overflow-hidden shadow-sm"
        >
            <div id="calendar" class="p-4 min-h-[600px]"></div>
        </div>
    </section>
</Layout>

<script define:vars={{ eventsData: formattedEvents }}>
    document.addEventListener("DOMContentLoaded", () => {
        const calendarEl = document.getElementById("calendar");

        // Verificação de segurança se FullCalendar foi carregado
        if (typeof FullCalendar === "undefined") {
            console.error("FullCalendar not loaded properly.");
            if (calendarEl)
                calendarEl.innerHTML =
                    '<div class="p-4 text-red-500">Erro ao carregar calendário. Por favor, recarregue a página.</div>';
            return;
        }

        if (!calendarEl) {
            console.error("Calendar element not found");
            return;
        }

        try {
            const calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: "dayGridMonth",
                initialDate: new Date(),
                locale: "pt-br",
                headerToolbar: {
                    left: "prev,next today",
                    center: "title",
                    right: "dayGridMonth,timeGridWeek,multiMonthYear",
                },
                buttonText: {
                    today: "hoje",
                    month: "mês",
                    week: "semana",
                    year: "ano",
                    list: "lista",
                },
                firstDay: 1, // Segunda-feira
                events: eventsData,
                eventClick: function (info) {
                    const event = info.event;
                    const props = event.extendedProps;

                    const category = props.category || "Geral";
                    const description = props.description || "";

                    let details = `\n\nCategoria: ${category}`;
                    if (description) details += `\n\n${description}`;

                    alert(`${event.title}${details}`);
                },
                eventDisplay: "block",
                height: "auto",
                contentHeight: "auto",
                aspectRatio: 1.8,
                dayMaxEvents: true,
            });

            calendar.render();

            // Filtros
            const categoryFilters = document.querySelectorAll(".filter-btn");
            let activeCategory = "all";

            function applyFilters() {
                const allEvents = calendar.getEvents();

                allEvents.forEach((event) => {
                    const props = event.extendedProps;
                    const eventCategory = props.category || "";

                    let show = true;
                    if (
                        activeCategory !== "all" &&
                        eventCategory !== activeCategory
                    )
                        show = false;

                    if (show) {
                        event.setProp("display", "auto");
                    } else {
                        event.setProp("display", "none");
                    }
                });
            }

            categoryFilters.forEach((btn) => {
                btn.addEventListener("click", function () {
                    const category = this.getAttribute("data-category");
                    activeCategory = category || "all";

                    categoryFilters.forEach((b) =>
                        b.classList.remove(
                            "active",
                            "bg-neutral-100",
                            "dark:bg-neutral-800",
                            "font-medium",
                        ),
                    );
                    this.classList.add(
                        "active",
                        "bg-neutral-100",
                        "dark:bg-neutral-800",
                        "font-medium",
                    );

                    applyFilters();
                });
            });
        } catch (e) {
            console.error("Error initializing calendar:", e);
        }
    });
</script>

<style>
    /* Overrides para o FullCalendar se integrar ao tema */
    :global(.fc) {
        font-family: inherit;
        --fc-border-color: rgb(229 229 229);
        --fc-page-bg-color: transparent;
        --fc-neutral-bg-color: rgba(0, 0, 0, 0.03);
        --fc-list-event-hover-bg-color: rgba(0, 0, 0, 0.05);
        --fc-today-bg-color: rgba(0, 0, 0, 0.03);
    }

    .dark :global(.fc) {
        --fc-border-color: rgb(38 38 38);
        --fc-page-bg-color: transparent;
        --fc-neutral-bg-color: rgba(255, 255, 255, 0.05);
        --fc-list-event-hover-bg-color: rgba(255, 255, 255, 0.1);
        --fc-today-bg-color: rgba(255, 255, 255, 0.05);
    }

    /* Toolbar */
    :global(.fc-header-toolbar) {
        margin-bottom: 2rem !important;
        gap: 1rem;
    }

    :global(.fc-toolbar-title) {
        font-size: 1.25rem !important; /* 20px */
        font-weight: 500 !important;
        letter-spacing: -0.02em;
    }

    :global(.fc-button) {
        text-transform: lowercase !important;
        font-weight: 500 !important;
        border-radius: 9999px !important; /* Pill shape */
        padding: 0.25rem 1rem !important;
        background-color: transparent !important;
        border: 1px solid transparent !important;
        color: rgb(115 115 115) !important; /* neutral-500 */
        box-shadow: none !important;
        transition: all 0.2s ease;
    }

    :global(.fc-button:hover) {
        color: rgb(23 23 23) !important;
        background-color: rgba(0, 0, 0, 0.05) !important;
    }

    :global(.fc-button-active) {
        background-color: rgb(23 23 23) !important; /* black */
        color: white !important;
    }

    .dark :global(.fc-button) {
        color: rgb(163 163 163) !important; /* neutral-400 */
    }
    .dark :global(.fc-button:hover) {
        color: white !important;
        background-color: rgba(255, 255, 255, 0.1) !important;
    }
    .dark :global(.fc-button-active) {
        background-color: white !important;
        color: black !important;
    }

    /* Icons in buttons (prev/next) */
    :global(.fc-icon) {
        font-size: 1rem !important;
    }

    /* Today Highlight - More Prominent */
    :global(.fc-day-today) {
        background-color: transparent !important;
        position: relative;
    }

    /* Create a marked visual for today */
    :global(.fc-daygrid-day.fc-day-today .fc-daygrid-day-number) {
        background-color: rgb(23 23 23);
        color: white;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 4px;
    }

    .dark :global(.fc-daygrid-day.fc-day-today .fc-daygrid-day-number) {
        background-color: white;
        color: black;
    }

    /* Events */
    :global(.fc-event) {
        border: none !important;
        border-radius: 2px !important;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        padding: 2px 4px !important;
    }

    /* Headers */
    :global(.fc-col-header-cell) {
        background-color: rgb(250 250 250);
        padding: 8px 0 !important;
    }
    .dark :global(.fc-col-header-cell) {
        background-color: rgb(23 23 23);
    }

    :global(.fc-col-header-cell-cushion) {
        text-transform: lowercase;
        font-weight: 500 !important;
        color: rgb(115 115 115) !important;
    }

    /* MultiMonth View specific */
    :global(.fc-multimonth-title) {
        font-size: 1rem !important;
        font-weight: 500 !important;
    }

    /* Grid lines */
    :global(.fc-theme-standard td),
    :global(.fc-theme-standard th) {
        border-color: rgb(245 245 245) !important; /* Very light gray */
    }
    .dark :global(.fc-theme-standard td),
    .dark :global(.fc-theme-standard th) {
        border-color: rgb(38 38 38) !important;
    }

    /* Mobile Responsiveness */
    @media (max-width: 640px) {
        :global(.fc-header-toolbar) {
            flex-direction: column;
            gap: 1rem !important;
            align-items: flex-start !important;
        }

        :global(.fc-toolbar-chunk) {
            width: 100%;
            display: flex;
            justify-content: space-between;
        }

        /* Center the title chunk */
        :global(.fc-toolbar-chunk:nth-child(2)) {
            justify-content: center;
        }
    }
</style>
