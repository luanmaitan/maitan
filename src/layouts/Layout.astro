---
// src/layouts/Layout.astro
// Importando as fontes que instalamos
import "@fontsource/rethink-sans";
import "@fontsource/hedvig-letters-serif";
import "@fontsource/ibm-plex-mono";
import MobileMenu from "../components/MobileMenu.svelte";
import ThemeToggle from "../components/ThemeToggle.svelte";
import FooterInfo from "../components/FooterInfo.svelte";
import SpeedInsights from "@vercel/speed-insights/astro";
import Search from "../components/Search.svelte";
import { navigation } from "../lib/navigation";

	interface Props {
		title: string;
		sidebarLayout?: boolean; // Mantido para compatibilidade, mas a lógica muda
	}

	const { title, sidebarLayout = true } = Astro.props;
    const hasSidebar = Astro.slots.has('sidebar');

// Dynamic counts for subpages
const escritorioFiles = import.meta.glob('../pages/escritorio/*.astro');
const observatorioFiles = import.meta.glob('../pages/observatorio/*.astro');

const getCount = (globResult: Record<string, any>, excludeIndex = false) => {
    return Object.keys(globResult).filter(path => {
        if (path.includes('[...slug]')) return false;
        if (excludeIndex && path.includes('index.astro')) return false;
        return true;
    }).length;
}

const sectionCounts: Record<string, number> = {
    '/escritorio': getCount(escritorioFiles),
    '/observatorio': getCount(observatorioFiles, true),
    '/laboratorio': 1,
    '/portfolio': 1,
};

const navigationWithCounts = navigation.map(item => ({
    ...item,
    count: sectionCounts[item.href] || 0
}));

const currentPath = Astro.url.pathname;
---

<!doctype html>
<html
	lang="pt-br"
	class="bg-white text-black antialiased scroll-smooth"
>
	<head>
		<meta charset="UTF-8" />
		<meta name="description" content="Luan Maitan - Jardim Digital" />
		<meta name="viewport" content="width=device-width" />
		<link rel="icon" type="image/jpeg" href="/favicon.jpg" />
		<meta name="generator" content={Astro.generator} />
		<title>{title}</title>
		<script is:inline>
			const theme = (() => {
				if (typeof localStorage !== "undefined" && localStorage.getItem("theme")) {
					return localStorage.getItem("theme");
				}
				if (window.matchMedia("(prefers-color-scheme: dark)").matches) {
					return "dark";
				}
				return "light";
			})();

			if (theme === "dark") {
				document.documentElement.classList.add("dark");
			} else {
				document.documentElement.classList.remove("dark");
			}
			window.localStorage.setItem("theme", theme);
		</script>
	</head>
	<body
		class="font-sans bg-white dark:bg-neutral-900 text-black dark:text-white transition-colors duration-300 flex flex-col min-h-screen lg:flex-row"
	>
		<!-- Desktop Sidebar -->
		<aside
			class="hidden lg:flex fixed top-0 left-0 h-screen w-[250px] flex-col border-r border-[rgba(0,0,0,0.1)] dark:border-neutral-800 bg-white dark:bg-neutral-900 z-50 transition-colors duration-300"
		>
            <!-- 1. Logo Section + Theme Toggle -->
			<div class="relative shrink-0 w-full">
                <div class="flex flex-row justify-between items-center pl-[32px] pr-[20px] py-[30px]">
                    <a
                        href="/"
                        class="flex items-center gap-2 text-[18px] font-bold text-black dark:text-white leading-none lowercase"
                    >
                        <!-- Logo text is explicitly lowercase as requested -->
                        <p>luan maitan</p>
                    </a>
                    <ThemeToggle client:load />
                </div>
                <div class="absolute bottom-0 left-0 right-0 border-b border-[rgba(0,0,0,0.1)] dark:border-neutral-800 pointer-events-none"></div>
			</div>

            <!-- Search Section (Desktop) -->
            <div class="relative shrink-0 w-full border-b border-[rgba(0,0,0,0.1)] dark:border-neutral-800">
                <div class="px-[32px] py-[20px]">
                    <Search client:load variant="desktop" />
                </div>
            </div>

            <!-- 2. Contents Section (Dynamic) -->
			<div class="relative shrink-0 w-full flex-1 overflow-y-auto">
                {hasSidebar ? (
                     // Subpage Sidebar Content
                    <div class="flex flex-col gap-4 items-start pt-[30px] pb-[30px] pl-[32px] pr-[20px] animate-in slide-in-from-left-4 fade-in duration-300">
                        <slot name="sidebar" />
                    </div>
                ) : (
                    // Main Navigation
                    <nav class="flex flex-col gap-[10px] items-start pt-[30px] pb-[30px] pl-[32px] pr-[20px]">
                        {
                            navigationWithCounts.map((item) => {
                                const isActive = currentPath.startsWith(item.href);
                                return (
                                <a
                                    href={item.href}
                                    class="w-full flex flex-col cursor-pointer group"
                                    aria-label={`Go to ${item.name}`}
                                >
                                    {/* Link Text */}
                                    <div class="flex flex-col justify-center relative shrink-0">
                                        <p class:list={[
                                            "text-[15px] font-medium leading-[1.2] tracking-[-0.3px] whitespace-pre transition-colors lowercase",
                                            isActive ? "text-black dark:text-white" : "text-black dark:text-neutral-200 hover:opacity-70"
                                        ]}>
                                            {item.name}
                                        </p>
                                    </div>
                                    
                                    {/* Link Number - BELOW on Desktop */}
                                    <div class="flex flex-col justify-center relative shrink-0 mt-0.5">
                                        <p class="text-[#575757] dark:text-neutral-500 text-[10px] tracking-[-0.2px] leading-[1.2] whitespace-pre -mt-0.5">
                                            {String(item.count).padStart(2, '0')}
                                        </p>
                                    </div>
                                </a>
                            )})
                        }
                    </nav>
                )}
			</div>

            <!-- 3. Footer Section (Clock & Secondary Links) -->
			<div class="relative shrink-0 w-full">
                
                <!-- Secondary Links (Colophon, Policy, CC) -->
				<div class="flex flex-col gap-[4px] items-start w-full pl-[32px] pr-[20px] pb-[20px]">
                    <a
                        href="/policy"
                        class="block cursor-pointer text-[10px] font-medium leading-[1.2] tracking-[-0.2px] text-[#575757] dark:text-neutral-400 hover:text-black dark:hover:text-white transition-colors lowercase"
                    >
                        políticas
                    </a>
                    <a
                        href="/colophon"
                        class="block cursor-pointer text-[10px] font-medium leading-[1.2] tracking-[-0.2px] text-[#575757] dark:text-neutral-400 hover:text-black dark:hover:text-white transition-colors lowercase"
                    >
                        colophon
                    </a>
                    <a
                        href="https://creativecommons.org/licenses/by-nc-sa/4.0/"
                        target="_blank"
                        class="block cursor-pointer text-[10px] font-medium leading-[1.2] tracking-[-0.2px] text-[#575757] dark:text-neutral-400 hover:text-black dark:hover:text-white transition-colors lowercase"
                    >
                        cc by-nc-sa
                    </a>
				</div>

                <!-- Divider before Clock -->
                <div class="w-full border-b border-[rgba(0,0,0,0.1)] dark:border-neutral-800 pointer-events-none"></div>

				<div class="flex flex-col gap-[20px] items-start pl-[32px] pr-[20px] py-[30px]">
                    <!-- Clock & Weather (Black Text) -->
                    <div class="text-black dark:text-white text-[15px] tracking-[-0.3px] leading-[1.2] font-medium">
                        <FooterInfo client:load />
                    </div>
				</div>
			</div>
		</aside>

		<!-- Tablet/Mobile Header (Visible on < lg) -->
		<header
			class="lg:hidden fixed top-0 left-0 w-full bg-white/95 dark:bg-neutral-900/95 backdrop-blur-sm z-50 transition-colors duration-300 border-b border-[rgba(0,0,0,0.1)] dark:border-neutral-800"
		>
			<!-- Row 1: Logo + Divider + Nav (Tablet) + Controls -->
			<div
				class="px-6 py-4 flex justify-between items-center relative"
			>
                <div class="flex items-center gap-6">
                    <a
                        href="/"
                        class="text-[18px] font-bold text-black dark:text-white leading-none lowercase"
                    >
                        luan maitan
                    </a>
                    
                    <!-- Vertical Divider (Tablet Only) - Now Full Height -->
                    <div class="hidden md:block absolute top-0 bottom-0 left-[150px] w-px bg-[rgba(0,0,0,0.1)] dark:bg-neutral-800 h-full"></div>
                    
                    <!-- Navigation (Tablet Only) -->
                    <div class="hidden md:flex items-center gap-6 ml-8">
                        {
                            navigationWithCounts.map((item) => (
                                <div class="flex items-center gap-1">
                                    <a
                                        href={item.href}
                                        class="relative group text-[15px] font-medium tracking-[-0.3px] text-[#575757] hover:text-black dark:text-neutral-400 dark:hover:text-white whitespace-nowrap transition-colors lowercase"
                                    >
                                        {item.name}
                                        <sup class="text-[9px] text-[#575757] dark:text-neutral-500 tracking-[-0.2px] ml-0.5 absolute -top-1 -right-1.5">
                                            {String(item.count).padStart(2, '0')}
                                        </sup>
                                    </a>
                                </div>
                            ))
                        }
                    </div>
                </div>

				<div class="flex items-center gap-4">
                    <Search client:load variant="mobile" />
					<ThemeToggle client:load />
					<div class="md:hidden">
						<MobileMenu client:load currentPath={currentPath} />
					</div>
				</div>
			</div>

            <!-- Row 2: Subpage Sidebar Content (Tablet Only) -->
             {hasSidebar && (
                 <div class="hidden md:flex px-6 py-3 gap-6 overflow-x-auto border-t border-[rgba(0,0,0,0.1)] dark:border-neutral-800 bg-neutral-50 dark:bg-neutral-900/50 items-center">
                     <slot name="sidebar" />
                 </div>
             )}
		</header>

		<!-- Main Content -->
		<main
			class:list={[
				"flex-1 w-full mx-auto px-6 py-8 lg:p-16 lg:ml-[250px]", 
				"pt-24 md:pt-20 lg:pt-16", // Reduced padding on tablet since nav is now inline
                // Se houver sidebar no tablet, precisamos de mais padding top
                hasSidebar ? "md:pt-40 lg:pt-16" : ""
			]}
		>
             <!-- Conteúdo da Sidebar para Mobile (visível apenas < md se necessário, mas o user não pediu explicitamente mobile, só tablet. Vou deixar no main flow para mobile ou esconder se for duplicado) -->
             <!-- A estratégia atual renderiza slot="sidebar" dentro do Header para Tablet e dentro da Sidebar para Desktop. Para Mobile (<md), ele não está renderizando. Onde mostrar? -->
             <!-- No mobile, a "sidebar" geralmente é o conteúdo principal ou um menu. Vou renderizar no topo do main para mobile -->
            <div class="md:hidden mb-8 border-b border-neutral-200 dark:border-neutral-800 pb-4">
                {hasSidebar && (
                    <div class="flex flex-col gap-4">
                         <slot name="sidebar" />
                    </div>
                )}
            </div>

			<slot />
		</main>

		<!-- Footer (Mobile Only) -->
		<footer
			class="lg:hidden w-full border-t border-[rgba(0,0,0,0.1)] dark:border-neutral-800 bg-white dark:bg-neutral-900 px-6 py-6 mt-auto"
		>
			<div class="flex justify-between items-center text-black dark:text-white">
				<div class="flex items-center">
                     <FooterInfo client:load />
				</div>
				
				<div class="flex gap-6 text-xs font-mono">
                    <a href="/colophon" class="hover:opacity-70 transition-opacity lowercase">colophon</a>
                    <!-- Other links moved to MobileMenu as requested -->
				</div>
			</div>
		</footer>
	</body>
</html>

<style is:global>
	/* Redo Design System Typography */
	
	/* Serif for editorial content */
	.prose {
		font-family: "Hedvig Letters Serif", serif;
	}
	
	/* Sans for UI */
	body {
		font-family: "Rethink Sans", sans-serif;
		font-size: 16px;
		line-height: 1.5;
	}

	/* Mono for code */
	code, pre {
		font-family: "IBM Plex Mono", monospace;
	}

	/* Focus Styles */
	:focus-visible {
		outline: 2px solid #FA9819; /* Redo Orange */
		outline-offset: 2px;
	}

	/* Link Styles (underline) */
	a {
		text-decoration-thickness: 1px;
	}
	a:hover {
		text-decoration-thickness: 2px;
	}
</style>
