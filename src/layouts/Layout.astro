---
// src/layouts/Layout.astro
// Importando as fontes que instalamos
import "@fontsource/rethink-sans";
import "@fontsource/hedvig-letters-serif";
import "@fontsource/ibm-plex-mono";
import MobileMenu from "../components/MobileMenu.svelte";
import ThemeToggle from "../components/ThemeToggle.svelte";
import FooterInfo from "../components/FooterInfo.svelte";
import SpeedInsights from "@vercel/speed-insights/astro";
import { navigation } from "../lib/navigation";

interface Props {
	title: string;
}

const { title } = Astro.props;

// Dynamic counts for subpages
const escritorioFiles = import.meta.glob('../pages/escritorio/*.astro');
const observatorioFiles = import.meta.glob('../pages/observatorio/*.astro');

const getCount = (globResult: Record<string, any>, excludeIndex = false) => {
    return Object.keys(globResult).filter(path => {
        if (path.includes('[...slug]')) return false;
        if (excludeIndex && path.includes('index.astro')) return false;
        return true;
    }).length;
}

const sectionCounts: Record<string, number> = {
    '/escritorio': getCount(escritorioFiles),
    '/observatorio': getCount(observatorioFiles, true),
    '/laboratorio': 1,
    '/portfolio': 1,
};

const navigationWithCounts = navigation.map(item => ({
    ...item,
    count: sectionCounts[item.href] || 0
}));

const currentPath = Astro.url.pathname;
---

<!doctype html>
<html
	lang="pt-br"
	class="bg-white text-black antialiased scroll-smooth"
>
	<head>
		<meta charset="UTF-8" />
		<meta name="description" content="Luan Maitan - Jardim Digital" />
		<meta name="viewport" content="width=device-width" />
		<link rel="icon" type="image/jpeg" href="/favicon.jpg" />
		<meta name="generator" content={Astro.generator} />
		<title>{title}</title>
		<script is:inline>
			const theme = (() => {
				if (typeof localStorage !== "undefined" && localStorage.getItem("theme")) {
					return localStorage.getItem("theme");
				}
				if (window.matchMedia("(prefers-color-scheme: dark)").matches) {
					return "dark";
				}
				return "light";
			})();

			if (theme === "dark") {
				document.documentElement.classList.add("dark");
			} else {
				document.documentElement.classList.remove("dark");
			}
			window.localStorage.setItem("theme", theme);
		</script>
	</head>
	<body
		class="font-sans bg-white dark:bg-neutral-900 text-black dark:text-white transition-colors duration-300 flex flex-col min-h-screen lg:flex-row"
	>
		<!-- Desktop Sidebar -->
		<aside
			class="hidden lg:flex fixed top-0 left-0 h-screen w-[250px] flex-col border-r border-[rgba(0,0,0,0.1)] dark:border-neutral-800 bg-white dark:bg-neutral-900 z-50 transition-colors duration-300"
		>
            <!-- 1. Logo Section + Theme Toggle -->
			<div class="relative shrink-0 w-full">
                <div class="flex flex-row justify-between items-center pl-[32px] pr-[20px] py-[30px]">
                    <a
                        href="/"
                        class="flex items-center gap-2 text-[18px] font-bold text-black dark:text-white leading-none lowercase"
                    >
                        <!-- Logo text is explicitly lowercase as requested -->
                        <p>luan maitan</p>
                    </a>
                    <ThemeToggle client:load />
                </div>
                <div class="absolute bottom-0 left-0 right-0 border-b border-[rgba(0,0,0,0.1)] dark:border-neutral-800 pointer-events-none"></div>
			</div>

            <!-- 2. Contents Section -->
			<div class="relative shrink-0 w-full flex-1 overflow-y-auto">
                <!-- Main Nav -->
				<nav class="flex flex-col gap-[10px] items-start pt-[30px] pb-[30px] pl-[32px] pr-[20px]">
					{
						navigationWithCounts.map((item) => {
                            const isActive = currentPath.startsWith(item.href);
                            return (
							<a
								href={item.href}
								class="w-full flex flex-col cursor-pointer group"
                                aria-label={`Go to ${item.name}`}
							>
                                {/* Link Text */}
                                <div class="flex flex-col justify-center relative shrink-0">
                                    <p class:list={[
                                        "text-[15px] font-medium leading-[1.2] tracking-[-0.3px] whitespace-pre transition-colors lowercase",
                                        isActive ? "text-black dark:text-white" : "text-black dark:text-neutral-200 hover:opacity-70"
                                    ]}>
                                        {item.name}
                                    </p>
                                </div>
                                
                                {/* Link Number - BELOW on Desktop */}
                                <div class="flex flex-col justify-center relative shrink-0 mt-1">
                                    <p class="text-[#575757] dark:text-neutral-500 text-[10px] tracking-[-0.2px] leading-[1.2] whitespace-pre">
                                        {String(item.count).padStart(2, '0')}
                                    </p>
                                </div>
							</a>
						)})
					}
				</nav>

                <!-- Divider between Main Nav and Secondary Links -->
                <div class="w-full border-b border-[rgba(0,0,0,0.1)] dark:border-neutral-800 pointer-events-none"></div>

                <!-- Secondary Links (Colophon, Policy, CC) -->
                <div class="flex flex-col gap-[4px] items-start w-full pl-[32px] pr-[20px] py-[30px]">
                    <a
                        href="/colophon"
                        class="block cursor-pointer font-medium text-[15px] leading-[1.2] tracking-[-0.3px] text-[#575757] dark:text-neutral-400 hover:text-black dark:hover:text-white transition-colors lowercase"
                    >
                        colophon
                    </a>
                    <a
                        href="/policy"
                        class="block cursor-pointer font-medium text-[15px] leading-[1.2] tracking-[-0.3px] text-[#575757] dark:text-neutral-400 hover:text-black dark:hover:text-white transition-colors lowercase"
                    >
                        políticas
                    </a>
                    <a
                        href="https://creativecommons.org/licenses/by-nc-sa/4.0/"
                        target="_blank"
                        class="block cursor-pointer font-medium text-[15px] leading-[1.2] tracking-[-0.3px] text-[#575757] dark:text-neutral-400 hover:text-black dark:hover:text-white transition-colors lowercase"
                    >
                        cc by-nc-sa
                    </a>
                </div>

                <div class="absolute bottom-0 left-0 right-0 border-b border-[rgba(0,0,0,0.1)] dark:border-neutral-800 pointer-events-none"></div>
			</div>

            <!-- 3. Footer Section (Clock Only) -->
			<div class="relative shrink-0 w-full">
				<div class="flex flex-col gap-[20px] items-start pl-[32px] pr-[20px] py-[30px]">
                    <!-- Clock & Weather (Black Text) -->
                    <div class="text-black dark:text-white text-[15px] tracking-[-0.3px] leading-[1.2] font-medium">
                        <FooterInfo client:load />
                    </div>
				</div>
			</div>
		</aside>

		<!-- Tablet/Mobile Header (Visible on < lg) -->
		<header
			class="lg:hidden fixed top-0 left-0 w-full bg-white/95 dark:bg-neutral-900/95 backdrop-blur-sm z-50 transition-colors duration-300 border-b border-[rgba(0,0,0,0.1)] dark:border-neutral-800"
		>
			<!-- Row 1: Logo + Controls -->
			<div
				class="px-6 py-4 flex justify-between items-center"
			>
				<a
					href="/"
					class="text-[18px] font-bold text-black dark:text-white leading-none lowercase"
				>
					luan maitan
				</a>
				<div class="flex items-center gap-4">
					<ThemeToggle client:load />
					<div class="md:hidden">
						<MobileMenu client:load />
					</div>
				</div>
			</div>

			<!-- Row 2: Navigation (Tablet Only: md -> lg) -->
			<div
				class="hidden md:flex px-6 py-3 gap-6 overflow-x-auto"
			>
				{
					navigationWithCounts.map((item) => (
						<div class="flex items-center gap-2">
                            <a
                                href={item.href}
                                class="text-[15px] font-medium tracking-[-0.3px] text-[#575757] hover:text-black dark:text-neutral-400 dark:hover:text-white whitespace-nowrap transition-colors lowercase"
                            >
                                {item.name}
                            </a>
                            <!-- Number beside link on tablet -->
                            <span class="text-[10px] text-[#575757] dark:text-neutral-500 tracking-[-0.2px]">
                                {String(item.count).padStart(2, '0')}
                            </span>
                        </div>
					))
				}
			</div>
		</header>

		<!-- Main Content -->
		<main
			class:list={[
				"flex-1 w-full mx-auto p-8 lg:p-16 lg:ml-[250px]", 
				"pt-24 md:pt-32 lg:pt-16",
				// Two-column grid for desktop
				"grid lg:grid-cols-[400px_1fr] gap-12 items-start" 
			]}
		>
            <!-- Left Column: Title & Submenu (passed via slot="sidebar") -->
            <div class="flex flex-col gap-8">
                <slot name="sidebar" />
            </div>

            <!-- Right Column: Main Content -->
			<div class="min-w-0">
				<slot />
			</div>
		</main>

		<!-- Footer (Mobile Only) -->
		<footer
			class="lg:hidden w-full border-t border-[rgba(0,0,0,0.1)] dark:border-neutral-800 bg-white dark:bg-neutral-900 px-6 py-8 mt-auto"
		>
			<div
				class="max-w-7xl mx-auto flex flex-col gap-6"
			>
				<div class="flex flex-col gap-2 text-black dark:text-white text-[15px]">
                     <FooterInfo client:load />
				</div>
				
				<div class="border-t border-[rgba(0,0,0,0.1)] dark:border-neutral-800 pt-6 flex justify-between items-center text-[15px] tracking-[-0.3px]">
					<div class="flex gap-4 w-full justify-between">
                        <a href="/colophon" class="text-[#575757] hover:text-black dark:text-neutral-400 dark:hover:text-white transition-colors lowercase">colophon</a>
						<a href="/policy" class="text-[#575757] hover:text-black dark:text-neutral-400 dark:hover:text-white transition-colors lowercase">políticas</a>
					</div>
				</div>
			</div>
		</footer>
	</body>
</html>

<style is:global>
	/* Redo Design System Typography */
	
	/* Serif for editorial content */
	.prose {
		font-family: "Hedvig Letters Serif", serif;
	}
	
	/* Sans for UI */
	body {
		font-family: "Rethink Sans", sans-serif;
		font-size: 16px;
		line-height: 1.5;
	}

	/* Mono for code */
	code, pre {
		font-family: "IBM Plex Mono", monospace;
	}

	/* Focus Styles */
	:focus-visible {
		outline: 2px solid #FA9819; /* Redo Orange */
		outline-offset: 2px;
	}

	/* Link Styles (underline) */
	a {
		text-decoration-thickness: 1px;
	}
	a:hover {
		text-decoration-thickness: 2px;
	}
</style>
